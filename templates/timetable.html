<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/site.css') }}">
    <title>Avganger</title>
</head>

<body>
    <header style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">

        <details class="noarrow" id="config_menu">
            <summary>
                <big><strong>‚öô</strong></big>
            </summary>
            <div style="background-color: rgb(54, 46, 82);padding: 5px; border: 1px solid lightslategrey;">
                <textarea id="config_container">
{
    "motd": "Test 123",
    "busStops": [
        "studentersamfundet",
        "Olav Kyrres gate"
    ],
    "maxResultsToGet":50,
    "maxResultsToView":12,
    "busFilter": {
        "mode" :"include",
        "values": ["1","2","71","23","340"]
    }
}</textarea>
                <br>
                <button id="config_save" onclick="SaveConfig()">üíæ</button>
                <button id="config_save" onclick="LoadConfig()">‚èè</button>
                <button id="config_apply" onclick="ApplyConfig()">Apply</button>
                &nbsp;<code style="background-color: rgb(38, 33, 69); padding: 4px;" id="config_output"></code>
            </div>
        </details>

        <div style="display: flex;justify-content: flex-start;align-items: center;flex-direction: row;gap:10px;">
            <img height="75">
            <h1 onclick="ToggleMotd()">Avganger</h1>
        </div>
        <!-- MOTD -->
        <div id="motd_container">
            <div style="display: flex; justify-content: space-between; align-items: center;flex-direction: column;">
                <b>Dagens melding</b>
                <h2 id="motd"></h2>

            </div>
        </div>
        <h1 id="currentTime" style="padding: 20px;"></h1>
    </header>
    <div id="busStopsContainer" style="display: flex;">

    </div>

    <script>
        const defaultConfig = config_container.value;

        ApplyConfig()

        UpdateTime();

        UpdateTimeTable();

        setInterval(UpdateTimeTable, 5000);
        setInterval(UpdateTime, 1000);

        function SaveConfig() {
            ApplyConfig()
            const json = JSON.stringify(JSON.parse(config_container.value), null, 4);

            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "bus_stop_config.json";
            a.click();

            URL.revokeObjectURL(url);

            config_output.innerHTML = "Config exported";
        }

        async function LoadConfig() {
            const options = {
                types: [
                    {
                        description: 'JSON Files',
                        accept: {
                            'application/json': ['.json'],
                        },
                    },
                ],
                
                multiple: false,
            };

            const [fileHandle] = await window.showOpenFilePicker(options);

            const file = await fileHandle.getFile();

            if (file.size > 32768) {
                config_output.innerHTML = `Max file size: 32KB`;
                return;
            }

            const contents = await file.text();
            config_container.value = contents;
            ApplyConfig()
            config_output.innerHTML = `Config loaded: ${file.name}`;

        }

        // CTRL+Space for toggling config menu
        document.addEventListener("keydown", function (event) {

            if (event.ctrlKey && event.code === "Space") {
                event.preventDefault();

                config_menu.open = !config_menu.open;

                requestAnimationFrame(() => {
                    config_container.focus();
                });
            }
        });

        config_container.addEventListener("keydown", (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "s") {
                e.preventDefault();
                ApplyConfig();
            }
        });


        function GetCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
        }

        function ApplyConfig() {
            config_output.innerHTML = ""

            try {
                let configCookie = GetCookie("config");
                let confContainerCurrentValue = config_container.value;

                let valueIsDefault = configCookie === defaultConfig;

                let valueChangedByUser = confContainerCurrentValue !== defaultConfig && confContainerCurrentValue !== configCookie;

                if (!configCookie || valueIsDefault) {
                    configCookie = confContainerCurrentValue;
                }
                else {
                    if (valueChangedByUser) {
                        configCookie = confContainerCurrentValue;
                    }
                    else {
                        config_container.value = configCookie
                    }
                }

                JSON.parse(configCookie)

                config_output.innerHTML = "Config applied"
                document.cookie = `config=${encodeURIComponent(configCookie)}; path=/`

                UpdateMotd()

            } catch (error) {
                config_output.innerHTML = error
            }
        }

        function ToggleMotd() {
            motd_container.hidden = !motd_container.hidden;
        }

        function UpdateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            currentTime.textContent = `${hours}:${minutes}:${seconds}`;
        }

        function UpdateMotd() {
            let jsonConfig = GetCookie("config");
            let config = JSON.parse(jsonConfig);

            if (config.motd == "") {
                motd_container.hidden = true;
            }
            else {
                motd_container.hidden = false;
                motd.innerText = config.motd;
            }
        }

        function UpdateTimeTable() {
            let bodyContent = GetCookie("config")

            fetch('/api/timetable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: bodyContent
            })
                .then(response => response.json())
                .then(data => ProcessData(data))
                .catch(error => console.error('Error fetching timetable data:', error));
        }

        function ProcessData(data) {

            const bus_stop_container = document.querySelector('#busStopsContainer');
            bus_stop_container.innerHTML = '';
            data.sort((a, b) => a.stopName.localeCompare(b.stopName));

            data.forEach(busStop => {
                // Create a table for each bus stop
                const stopTable = document.createElement('table');
                stopTable.style.margin = "20px 0";
                stopTable.style.padding = "20px 0";
                stopTable.style.border = "1px solid black";

                // Add a header row with the stop name
                const headerRow = document.createElement('tr');
                const headerCell = document.createElement('th');
                headerCell.colSpan = 3;
                headerCell.textContent = busStop.stopName;
                headerCell.style.textAlign = 'center';
                headerRow.appendChild(headerCell);
                stopTable.appendChild(headerRow);

                // Add a sub-header row for column names
                const subHeaderRow = document.createElement('tr');
                subHeaderRow.innerHTML = `
                            <th>Linje</th>
                            <th></th>
                            <th>Ankomst</th>
                        `;
                stopTable.appendChild(subHeaderRow);

                // Add rows for each bus in this bus stop
                busStop.BusEntries.forEach(bus => {
                    const row = document.createElement('tr');
                    let timeCellStyle = "";
                    if (bus.hereIn.includes("Min") || bus.hereIn.includes("N√•")) {

                        if (bus.hereIn.includes("Min")) {
                            const minutes = parseInt(bus.hereIn.split(" ")[0]);
                            if (minutes < 5) {
                                timeCellStyle = "color: #FDFD96; font-weight: bold;";
                            }
                        }
                        if (bus.hereIn.includes("N√•")) {
                            timeCellStyle = "color: #9F1D35; font-weight: bold;";
                        }
                    }

                    row.innerHTML = `
                                <td id="busLine"><svg xmlns="http://www.w3.org/2000/svg" width="20" viewBox="0 0 576 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M288 0C422.4 0 512 35.2 512 80l0 16 0 32c17.7 0 32 14.3 32 32l0 64c0 17.7-14.3 32-32 32l0 160c0 17.7-14.3 32-32 32l0 32c0 17.7-14.3 32-32 32l-32 0c-17.7 0-32-14.3-32-32l0-32-192 0 0 32c0 17.7-14.3 32-32 32l-32 0c-17.7 0-32-14.3-32-32l0-32c-17.7 0-32-14.3-32-32l0-160c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32c0 0 0 0 0 0l0-32s0 0 0 0l0-16C64 35.2 153.6 0 288 0zM128 160l0 96c0 17.7 14.3 32 32 32l112 0 0-160-112 0c-17.7 0-32 14.3-32 32zM304 288l112 0c17.7 0 32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-112 0 0 160zM144 400a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm288 0a32 32 0 1 0 0-64 32 32 0 1 0 0 64zM384 80c0-8.8-7.2-16-16-16L208 64c-8.8 0-16 7.2-16 16s7.2 16 16 16l160 0c8.8 0 16-7.2 16-16z"/></svg>  ${bus.line}</td>
                                <td>${bus.destination}</td>
                                <td style="${timeCellStyle}">${bus.hereIn}</td>
                            `;

                    stopTable.appendChild(row);
                });

                // Append the table to the config_container
                bus_stop_container.appendChild(stopTable);
            });
        }

    </script>
</body>

</html>